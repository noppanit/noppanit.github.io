
<!doctype>
<html lang="en">
  <head>
    <meta content='JavaScript TDD on on file upload. - Noppanit' name='title' />
    <meta content='JavaScript TDD on on file upload. - Noppanit' name='og:title' />
    <title>JavaScript TDD on on file upload. - Noppanit</title>
    <link href='http://localhost:4000/images/fav.png' rel='shortcut icon'>
<link href='http://localhost:4000/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='http://localhost:4000/stylesheets/syntax.css' rel='stylesheet' type='text/css' />

<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <meta content='http://localhost:4000/posts/javascript-tdd-on-file-upload' property='og:url' />
  <meta content="Right now, I’m trying to do HTML5 file upload but I also want to write some test as well. So, I just want to post it ..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->





  </head>
  <body class="lh-copy dark-gray pa0 f6 sans-serif bg-super-white">
    <header class="tc mt4">
      <a href="http://localhost:4000">
        <img src="http://localhost:4000/images/scribble.png" alt="Home" width="53" height="59">
      </a>
      <p>Noppanit</p>
    </header>
    <div class="mw7 bg-white mt4 mb3 center br2-ns bt bb ba-ns b--light-gray">
      <nav class="bb b--light-gray pv4 tc" aria-label="Main">
        
      </nav>

      <main class="tl f6 relative pa4 pa5-ns overflow-hidden">
        
          <div class="mb4">
            <div class="fw600 light-silver mt1">10 Mar 2013</div>
            <h1 class="ttu f3 mt0 lh-title cb mb2">
              
              JavaScript TDD on on file upload.
            </h1>
            
          </div>
        
        <div class="markdown-body">
          <p>Right now, I’m trying to do HTML5 file upload but I also want to write some test as well. So, I just want to post it here. <a href="http://postposttechnical.com/2011/03/spying-with-jasmine/">http://postposttechnical.com/2011/03/spying-with-jasmine/</a> This blog post really inspires me on how to use Jasmine to drive JavaScript test. Maybe my code is wrong, but any feedback is welcome.</p>

<p>So, I have this code</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Uploader</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">file</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Uploader</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span>  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">upload_file</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">file_content</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">file_data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
    <span class="nx">file_data</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'filename'</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">file_data</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'mimetype'</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="nx">file_data</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="nx">file_content</span><span class="p">);</span>
    <span class="nx">file_data</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'size'</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
          <span class="na">url</span><span class="p">:</span> <span class="s2">"/upload/file"</span><span class="p">,</span>
          <span class="na">type</span><span class="p">:</span> <span class="s2">"POST"</span><span class="p">,</span>
          <span class="na">data</span><span class="p">:</span> <span class="nx">file_content</span><span class="p">,</span>         
          <span class="na">contentType</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
          <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
              
          <span class="p">},</span>
          <span class="na">error</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="p">},</span>
          <span class="na">xhr</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">myXhr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">xhr</span><span class="p">();</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">myXhr</span><span class="p">.</span><span class="nx">upload</span><span class="p">){</span>
                  <span class="nx">myXhr</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'progress'</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">progressbar</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Upload progress is not supported."</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">return</span> <span class="nx">myXhr</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">showPreview</span><span class="p">(</span><span class="nx">file_content</span><span class="p">,</span> <span class="nx">thumbnailDiv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"img"</span><span class="p">);</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span>  <span class="nx">file_content</span><span class="p">;</span>

    <span class="nx">thumbnailDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="na">upload</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">file_content</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
      
      <span class="nx">reader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"load"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">file_content</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

        <span class="nx">showPreview</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">thumbnailDiv</span><span class="p">);</span>
        <span class="nx">upload_file</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="nx">file_content</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
      

      <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">})();</span>
</code></pre></div></div>

<p>And this is my test</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s2">"Uploader"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">eventListener</span><span class="p">,</span>
    <span class="nx">fakeFile</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="s2">"ajax"</span><span class="p">);</span>
    <span class="nx">eventListener</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
    <span class="nx">spyOn</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">"FileReader"</span><span class="p">).</span><span class="nx">andReturn</span><span class="p">({</span>
      <span class="na">addEventListener</span><span class="p">:</span> <span class="nx">eventListener</span><span class="p">,</span>
      <span class="na">readAsDataURL</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do nothing.</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">uploader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uploader</span><span class="p">(</span><span class="nx">fakeFile</span><span class="p">);</span>

  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s2">"should upload a file successfully"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">thumbnailElement</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"&lt;div&gt;&lt;/div&gt;"</span><span class="p">);</span>
    <span class="nx">uploader</span><span class="p">.</span><span class="nx">upload</span><span class="p">({</span>
      <span class="na">progressbar</span> <span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="p">},</span>
      <span class="na">thumbnailDiv</span> <span class="p">:</span> <span class="nx">thumbnailElement</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">eventListener</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'load'</span><span class="p">);</span>
    
    <span class="nx">eventListener</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]({</span>
      <span class="na">target</span> <span class="p">:</span> <span class="p">{</span>
        <span class="na">result</span> <span class="p">:</span> <span class="s1">'file content'</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"url"</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s2">"/upload/file"</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s2">"POST"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s2">"should show a preview image"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">thumbnailElement</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">thumbnailElement</span><span class="p">.</span><span class="nx">append</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s2">"fake thumbnail div"</span><span class="p">);</span>

    <span class="nx">uploader</span><span class="p">.</span><span class="nx">upload</span><span class="p">({</span>
      <span class="na">progressbar</span> <span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="p">},</span>
      <span class="na">thumbnailDiv</span> <span class="p">:</span> <span class="nx">thumbnailElement</span>
    <span class="p">});</span>

    <span class="nx">eventListener</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]({</span>
      <span class="na">target</span> <span class="p">:</span> <span class="p">{</span>
        <span class="na">result</span> <span class="p">:</span> <span class="s1">'file_content'</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">thumbnailElement</span><span class="p">.</span><span class="nx">append</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
    <span class="nx">hasFileSrc</span> <span class="o">=</span> <span class="nx">thumbnailElement</span><span class="p">.</span><span class="nx">append</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">src</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"file_content"</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">hasFileSrc</span><span class="p">).</span><span class="nx">toNotEqual</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>I had to spy on FileReader in order to test it. But it really help me improve my code.</p>

        </div>
        <p class="mt4">
  Til next time,<br>
  noppanit
  <span class="silver">at 00:00</span>
</p>
<img src="http://localhost:4000/images/scribble3.png" alt="scribble" />

      </main>
      <section class="fixed-l mw7 center w-100 top-50 tc pb4 nt4">
  
    <a href="http://localhost:4000/posts/flask-and-rq-example-for-heroku" class="no-underline f1 light-blue hover-silver nl5 fl-l ph3">‹</a>
  
  
    <a href="http://localhost:4000/posts/maybe-i-have-just-got-scroogled" class="no-underline f1 light-blue hover-silver nr5 fr-l ph3">›</a>
  
</section>
    </div>
    <footer class="mw7 center tc pt3 pb4 silver">
      Built with Jekyll using <a href="http://github.com/muan/scribble" class="link silver hover-blue pv1">Scribble</a>.
      <img src="http://localhost:4000/images/scribble2.png" alt="scribble" class="mt4 db center" />
    </footer>
  </body>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</html>

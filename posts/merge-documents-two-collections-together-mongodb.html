
<!doctype>
<html lang="en">
  <head>
    <meta content='Merge documents from two collections together in MongoDb - Noppanit' name='title' />
    <meta content='Merge documents from two collections together in MongoDb - Noppanit' name='og:title' />
    <title>Merge documents from two collections together in MongoDb - Noppanit</title>
    <link href='https://www.noppanit.com/images/fav.png' rel='shortcut icon'>
<link href='https://www.noppanit.com/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='https://www.noppanit.com/stylesheets/syntax.css' rel='stylesheet' type='text/css' />

<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <meta content='https://www.noppanit.com/posts/merge-documents-two-collections-together-mongodb' property='og:url' />
  <meta content="The problem is I have a lot of documents in one collection and even a lot more documents in another collection. I wan..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->





  </head>
  <body class="lh-copy dark-gray pa0 f6 sans-serif bg-super-white">
    <header class="tc mt4">
      <a href="https://www.noppanit.com">
        <img src="https://www.noppanit.com/images/scribble.png" alt="Home" width="53" height="59">
      </a>
      <p>Noppanit</p>
    </header>
    <div class="mw7 bg-white mt4 mb3 center br2-ns bt bb ba-ns b--light-gray">
      <nav class="bb b--light-gray pv4 tc" aria-label="Main">
        
      </nav>

      <main class="tl f6 relative pa4 pa5-ns overflow-hidden">
        
          <div class="mb4">
            <div class="fw600 light-silver mt1">23 Jan 2014</div>
            <h1 class="ttu f3 mt0 lh-title cb mb2">
              
              Merge documents from two collections together in MongoDb
            </h1>
            
          </div>
        
        <div class="markdown-body">
          <p>The problem is I have a lot of documents in one collection and even a lot more documents in another collection. I want to merge those documents together but I don’t want to write a lot of code to merge those documents together. It also might take a lot of time to do it.</p>

<p>MongoDb comes with <a href="http://docs.mongodb.org/manual/core/map-reduce/" title="mongodb map reduce">map/reduce</a> which is a cool feature you can use to achieve something like this. If you don’t know what map/reduce is I wrote an <a href="http://www.noppanit.com/mapreduce-dummies/">article</a> like this sometime ago.</p>

<p>Let’s say you have one collection with this document. Let’s say it’s <strong>products</strong> collection.&lt;/p&gt;</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"52e05133c68f0b2a95e2b67b"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="s2">"product_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"title"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Sharpie"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And another document in <strong>prices</strong> collection.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"52e05473c68f0b2a95e2b682"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="s2">"product_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"price"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>I want to end up with this.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="s2">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">"value"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"title"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Sharpie"</span><span class="p">,</span><span class="w"> </span><span class="s2">"price"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Here’s what you can do. Insert your data first.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="s2">"product_id"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"title"</span> <span class="p">:</span> <span class="s2">"Sharpie"</span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="s2">"product_id"</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"title"</span> <span class="p">:</span> <span class="s2">"Sticky"</span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">prices</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="s2">"product_id"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"price"</span> <span class="p">:</span> <span class="mi">99</span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">prices</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="s2">"product_id"</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"price"</span> <span class="p">:</span> <span class="mi">30</span><span class="p">});</span>
</code></pre></div></div>

<p>Then you build maps to get key/value from the documents</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">products_map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">product_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">"title"</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">});</span>
<span class="p">}</span>

<span class="nx">prices_map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">product_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">"price"</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">price</span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Then you build your reduce function</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">r</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">"title"</span> <span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="s2">"price"</span> <span class="p">:</span> <span class="s2">""</span>
    <span class="p">};</span>

    <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span><span class="nx">result</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">title</span><span class="p">;}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">price</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span><span class="nx">result</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">price</span><span class="p">;}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Then you run your map/reduce function.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">products_map</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="p">{</span><span class="na">out</span><span class="p">:</span> <span class="p">{</span><span class="na">reduce</span> <span class="p">:</span> <span class="s1">'joined'</span><span class="p">}});</span>
<span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">prices</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">prices_map</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="p">{</span><span class="na">out</span><span class="p">:</span> <span class="p">{</span><span class="na">reduce</span> <span class="p">:</span> <span class="s1">'joined'</span><span class="p">}});</span>
</code></pre></div></div>
<p>Then you will get another collection <strong>joined</strong> with the information you want. One caveat is right now map/reduce function will result in <strong>value : { “field” : “value” }</strong>.</p>


        </div>
        <p class="mt4">
  Til next time,<br>
  noppanit
  <span class="silver">at 00:00</span>
</p>
<img src="https://www.noppanit.com/images/scribble3.png" alt="scribble" />

      </main>
      <section class="fixed-l mw7 center w-100 top-50 tc pb4 nt4">
  
    <a href="https://www.noppanit.com/posts/thinking-functionally-for-idiots" class="no-underline f1 light-blue hover-silver nl5 fl-l ph3">‹</a>
  
  
    <a href="https://www.noppanit.com/posts/example-require-js-optimizer" class="no-underline f1 light-blue hover-silver nr5 fr-l ph3">›</a>
  
</section>
    </div>
    <footer class="mw7 center tc pt3 pb4 silver">
      Built with Jekyll using <a href="http://github.com/muan/scribble" class="link silver hover-blue pv1">Scribble</a>.
      <img src="https://www.noppanit.com/images/scribble2.png" alt="scribble" class="mt4 db center" />
    </footer>
  </body>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</html>

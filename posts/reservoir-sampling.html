
<!doctype>
<html lang="en">
  <head>
    <meta content='Reservoir sampling - Noppanit' name='title' />
    <meta content='Reservoir sampling - Noppanit' name='og:title' />
    <title>Reservoir sampling - Noppanit</title>
    <link href='http://localhost:4000/images/fav.png' rel='shortcut icon'>
<link href='http://localhost:4000/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='http://localhost:4000/stylesheets/syntax.css' rel='stylesheet' type='text/css' />

<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <meta content='http://localhost:4000/posts/reservoir-sampling' property='og:url' />
  <meta content="I have been working with Stream processing a lot lately. Here’s my usecase.Problem:I have a stream of pageviews. But ..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->





  </head>
  <body class="lh-copy dark-gray pa0 f6 sans-serif bg-super-white">
    <header class="tc mt4">
      <a href="http://localhost:4000">
        <img src="http://localhost:4000/images/scribble.png" alt="Home" width="53" height="59">
      </a>
      <p>Noppanit</p>
    </header>
    <div class="mw7 bg-white mt4 mb3 center br2-ns bt bb ba-ns b--light-gray">
      <nav class="bb b--light-gray pv4 tc" aria-label="Main">
        
      </nav>

      <main class="tl f6 relative pa4 pa5-ns overflow-hidden">
        
          <div class="mb4">
            <div class="fw600 light-silver mt1">20 Feb 2017</div>
            <h1 class="ttu f3 mt0 lh-title cb mb2">
              
              Reservoir sampling
            </h1>
            
          </div>
        
        <div class="markdown-body">
          <p>I have been working with Stream processing a lot lately. Here’s my usecase.</p>

<h2 id="problem">Problem:</h2>

<p>I have a stream of pageviews. But I don’t want to process every single pageview, because then I will process one pageview over and over again.
How do I sample the data so that I process just a subset of data but with equal probability of processing each pageview.</p>

<p>For example,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[pageview1, pageview2, pageview1, pageview3]
</code></pre></div></div>

<p>Now I want to choose 3 pageviews out of 4</p>

<h2 id="solution">Solution:</h2>
<p>We choose <code class="highlighter-rouge">[pageview1, pageview2, pageview1]</code> as the initial reservior. Then I choose pageview3 with a probability of 3/4</p>

<h2 id="code">Code</h2>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">samples</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">const</span> <span class="nx">sampleSize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">pageviews</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">record</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">sampleSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">samples</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">record</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">index</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rand</span> <span class="o">&lt;</span> <span class="nx">sampleSize</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">samples</span><span class="p">[</span><span class="nx">rand</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>I might not explain the math clearly, because I’m not very good at math. If you want to know more I recommend <a href="https://gregable.com/2007/10/reservoir-sampling.html">this</a> and <a href="https://jeremykun.com/2013/07/05/reservoir-sampling/">this</a> and <a href="https://discuss.leetcode.com/topic/53753/brief-explanation-for-reservoir-sampling">this</a> and <a href="http://austinrochford.com/posts/2014-11-30-reservoir-sampling.html">this</a>. There’s also my <a href="https://stackoverflow.com/questions/42046581/is-sample-size-of-1-consider-reservoir-sampling/42053227?noredirect=1#comment71830111_42053227">question</a> on SO about proof.</p>


        </div>
        <p class="mt4">
  Til next time,<br>
  noppanit
  <span class="silver">at 00:00</span>
</p>
<img src="http://localhost:4000/images/scribble3.png" alt="scribble" />

      </main>
      <section class="fixed-l mw7 center w-100 top-50 tc pb4 nt4">
  
    <a href="http://localhost:4000/posts/python-request-connection-aborted-and-broken-pipe-error" class="no-underline f1 light-blue hover-silver nl5 fl-l ph3">‹</a>
  
  
    <a href="http://localhost:4000/posts/osx-convert-raw-dng-to-jpg" class="no-underline f1 light-blue hover-silver nr5 fr-l ph3">›</a>
  
</section>
    </div>
    <footer class="mw7 center tc pt3 pb4 silver">
      Built with Jekyll using <a href="http://github.com/muan/scribble" class="link silver hover-blue pv1">Scribble</a>.
      <img src="http://localhost:4000/images/scribble2.png" alt="scribble" class="mt4 db center" />
    </footer>
  </body>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</html>
